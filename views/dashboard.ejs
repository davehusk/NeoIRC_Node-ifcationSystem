<!DOCTYPE html>
<html>
<head>
  <title>Neo IRC â€” #<%= currentChannel %></title>
  <link rel="stylesheet" href="/styles.css">
  <script>
    window.currentUser = "<%= username %>";
  </script>
</head>
<body>
  <%- include('partials/_header') %>

  <main class="main-content">
    <h2>ğŸ§  <%= username %> in #<%= currentChannel %></h2>

    <div class="chat-layout">
      <!-- ğŸ‘¥ User Sidebar -->
      <aside class="user-list">
        <h3>ğŸ§¬ Users</h3>
        <ul id="user-list">
          <% users.forEach(user => { %>
            <li class="user-entry">
              <a class="mention-name" href="/profile/<%= user.username %>">@<%= user.username %></a>
              <% if (user.isOnline) { %>
                <span class="online">â—</span>
                <small>#<%= user.currentChannel || 'general' %></small>
              <% } else { %>
                <span class="offline">â—‹</span>
              <% } %>
            </li>
          <% }) %>
        </ul>
      </aside>

      <!-- ğŸ’¬ Chat Area -->
      <section class="chat-box">
        <div id="chat-stream" class="chat-stream">
          <% messages.forEach(msg => {
            const isPrivate = msg.isPrivate;
            const isNeo = msg.sender === 'Neo';
            const isOwn = msg.sender === username;
            const userClass = `user-${msg.sender.toLowerCase()}`;
            const ownClass = isOwn ? 'own-msg' : '';
            const botClass = isNeo ? 'neo-msg' : '';
            const avatarIcon = isNeo ? 'ğŸ¤–' : 'ğŸ‘¤';
          %>
          <div class="chat-msg <%= userClass %> <%= ownClass %> <%= botClass %>">
            <div class="msg-avatar"><%= avatarIcon %></div>
            <div class="msg-content">
              <span class="mention-name" title="<%= new Date(msg.timestamp).toLocaleString() %>">@<%= msg.sender %></span>
              <span class="timestamp"><%= new Date(msg.timestamp).toLocaleString() %></span><br>
              <% if (msg.isPrivate) { %>
                <em>[Private to <%= msg.to %>]</em><br>
              <% } %>
              <%= msg.content %>
            </div>
          </div>
          <% }) %>
        </div>

        <!-- ğŸ“ Chat Input -->
        <form id="chat-form">
          <input type="text" id="message-input" name="message" placeholder="âœï¸ Type a message..." required />
          <input type="hidden" id="to-user" name="to" />
          <input type="hidden" id="channel-name" name="channel" value="<%= currentChannel %>" />
          <button type="submit">ğŸš€ Send</button>
        </form>
      </section>
    </div>
  </main>

  <script src="/frontend.js"></script>
  <script>
    messageInput?.addEventListener("keydown", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form?.dispatchEvent(new Event("submit"));
      }
    });
  </script>
  
</body>
</html>
