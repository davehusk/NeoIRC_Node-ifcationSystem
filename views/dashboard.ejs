<!DOCTYPE html>
<html>
<head>
    <title>Neo IRC Dashboard</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
<%- include('partials/_header') %>

<main class="main-content">
    <h2>ğŸ‘¤ Welcome, <%= username %> â€” Channel: #<%= currentChannel %></h2>

    <div class="chat-layout">
        <aside class="user-list">
            <h4>ğŸ§¬ Connected Users</h4>
            <ul id="user-list">
                <% users.forEach(user => { %>
                    <li class="user-entry" data-username="<%= user.username %>">
                        <%= user.username %>
                        <% if (user.isOnline) { %>
                            <span class="online">â—</span>
                            <a class="user-channel-link" href="/dashboard?channel=<%= user.currentChannel || 'general' %>">
                                <small>#<%= user.currentChannel || 'general' %></small>
                            </a>
                        <% } else { %>
                            <span class="offline">â—‹</span>
                        <% } %>
                    </li>
                <% }) %>
            </ul>
        </aside>

        <section class="chat-box">
            <div class="chat-tabs">
                <button class="tab-btn" data-target="chat-stream">ğŸ’¬ Chat</button>
                <button class="tab-btn" data-target="private-stream">ğŸ•µï¸ Private</button>
            </div>

            <div id="chat-stream" class="chat-stream active">
                <% messages.filter(msg => !msg.isPrivate && !msg.isAnnouncement).forEach(msg => { %>
                    <div>
                        <strong><%= msg.sender %></strong>
                        <span class="timestamp">[<%= new Date(msg.timestamp).toLocaleString() %>]</span><br>
                        <span><%= msg.content %></span>
                    </div>
                <% }) %>
            </div>

            <div id="private-stream" class="chat-stream">
                <% messages.filter(msg => msg.isPrivate).forEach(msg => { %>
                    <div>
                        <em>[Private to <%= msg.to %>]</em><br>
                        <strong><%= msg.sender %></strong>
                        <span class="timestamp">[<%= new Date(msg.timestamp).toLocaleString() %>]</span><br>
                        <span><%= msg.content %></span>
                    </div>
                <% }) %>
            </div>
        </section>
    </div>
<% if (typeof replyTo !== 'undefined') { %>
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById("to-user").value = "<%= replyTo %>";
            document.getElementById("message-input").focus();
        });
    </script>
<% } %>
<% if (isAdmin) { %>
    <form id="clear-chat-form">
        <input type="hidden" id="clear-channel" value="<%= currentChannel %>">
        <button type="submit">ğŸ§¹ Clear Chat in #<%= currentChannel %></button>
    </form>
    <% } %>
    

    <form id="chat-form">
        <input type="text" id="message-input" name="message" placeholder="âœï¸ Type message..." required>
        <input type="text" id="to-user" name="to" placeholder="ğŸ‘¤ Private to... (optional)">
        <input type="hidden" id="channel-name" name="channel" value="<%= currentChannel %>">
        <button type="submit">ğŸš€ Send</button>
    </form>
</main>

<script src="/frontend.js"></script>
<script>
    function toggleZoom() {
        document.body.classList.toggle('zoomed');
    }

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.chat-stream').forEach(s => s.classList.remove('active'));
            const id = btn.dataset.target;
            document.getElementById(id)?.classList.add('active');
        });
    });
</script>
</body>
</html>
